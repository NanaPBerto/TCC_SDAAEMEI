<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>Histórico de Atividades
                </h2>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sincronizarHistoricoComServidor()" title="Sincronizar com servidor">
                        <i class="bi bi-arrow-repeat"></i> Sincronizar
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="confirmarLimpezaHistorico()" title="Limpar todo histórico">
                        <i class="bi bi-trash"></i> Limpar
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="form-section">
                        <div id="historico-container" class="atividades-container">
                            {{#each historico}}
                                {{#if this}}
                                    {{> atividadeReduzida contexto="historico" atividade=this}}
                                {{/if}}
                            {{/each}}
                        </div>
                        
                        <div id="historico-vazio" class="text-center py-5" style="display: none;">
                            <i class="bi bi-clock display-1 text-muted mb-3"></i>
                            <h5 class="text-muted">Nenhuma atividade recente</h5>
                            <p class="text-muted">Comece explorando as atividades disponíveis</p>
                            <button class="btn btn-primary mt-3" onclick="window.location.href='/sugeridas'">
                                <i class="bi bi-compass me-2"></i>Explorar Atividades
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Função de confirmação para limpeza do histórico
function confirmarLimpezaHistorico() {
    const historico = obterHistorico();
    if (historico.length === 0) {
        alert('O histórico já está vazio.');
        return;
    }
    
    if (confirm(`Tem certeza que deseja limpar todo o histórico de atividades?\n\nEsta ação removerá ${historico.length} atividade(s) e não pode ser desfeita.`)) {
        const sucesso = limparHistoricoCompleto();
        if (sucesso) {
            alert('Histórico limpo com sucesso!');
        } else {
            alert('Erro ao limpar o histórico. Tente novamente.');
        }
    }
}

// Função para mostrar status da sincronização
// Função para mostrar status da sincronização
function mostrarStatusSincronizacao(mensagem, tipo = 'info') {
    console.log(`Sincronização: ${mensagem}`);
    
    // Remove toasts antigos
    document.querySelectorAll('.historico-toast').forEach(toast => toast.remove());
    
    // Cria novo toast
    const toast = document.createElement('div');
    toast.className = `historico-toast alert alert-${tipo === 'erro' ? 'danger' : tipo === 'sucesso' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 80px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `
        <strong>${tipo === 'erro' ? '❌ Erro' : tipo === 'sucesso' ? '✅ Sucesso' : 'ℹ️ Info'}</strong> 
        ${mensagem}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Remove automaticamente após 4 segundos
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 4000);
}
// Inicialização quando a página carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('Página de histórico carregada');
    
    // Sincroniza com servidor e depois carrega
    sincronizarHistoricoComServidor().then((historicoLimpo) => {
        carregarHistorico();
        if (historicoLimpo.length > 0) {
            console.log(`✅ Histórico sincronizado: ${historicoLimpo.length} atividades válidas`);
        }
    }).catch(error => {
        console.error('Erro na sincronização inicial:', error);
        mostrarStatusSincronizacao(error.message, 'erro');
        carregarHistorico(); // Carrega mesmo com erro
    });
});
</script>